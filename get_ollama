#!/bin/bash

# download the Ollama binary from the official website and installs it in the
# current directory.

TGT=$1
test -z $1 && TGT="."
mkdir -p $TGT
tgt=$TGT/ollama.tgz
bin=bin/ollama

ARCH=$(uname -m)
case "$ARCH" in
    x86_64       ) ARCH="amd64" ;;
    aarch64|arm64) ARCH="arm64" ;;
    *            )
        echo "Unsupported architecture: $ARCH"
        exit 1
        ;;
esac

if test -f $bin; then
    echo "Ollama is already installed."
    exit 1
fi

if test -f $tgt; then
    echo "Ollama download already started."
    cont='-C -' || cont=''
else
    echo "Downloading Ollama..."
    cont=''
fi

curl --fail $cont --show-error --location --progress-bar -o $tgt \
    "https://ollama.com/download/ollama-linux-${ARCH}.tgz"
tar xvf "$tgt"

chmod +x $tgt
V=$($bin --version 2>&1)

if ! test -z $V; then
    echo "Ollama $V has been installed successfully."
    echo "for available models, check https://ollama.com/library"
    echo "run `$bin start` to start the server (in a separate shell)."
    echo "run `$bin pull <model>` to download a model."
    echo "run `$bin run <model>` to run a model."

    exit 1
else
    echo "Failed to install Ollama ($V)."
    exit 1
fi

